[
  {
    "objectID": "src/from_cube_to_emerging_status.html",
    "href": "src/from_cube_to_emerging_status.html",
    "title": "Emerging status determination based on GBIF species occurrence cubes",
    "section": "",
    "text": "This document shows an example of how using GBIF species occurrence cubes to assess the emerging status of some (alien) species in Europe. This workflow is strongly based on occurrence TrIAS indicators.\n\n\nFirst, list and load the needed packages.\n\n\nCode\nlibrary(readr)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(purrr)\nlibrary(tibble)"
  },
  {
    "objectID": "src/from_cube_to_emerging_status.html#introduction",
    "href": "src/from_cube_to_emerging_status.html#introduction",
    "title": "Emerging status determination based on GBIF species occurrence cubes",
    "section": "",
    "text": "This document shows an example of how using GBIF species occurrence cubes to assess the emerging status of some (alien) species in Europe. This workflow is strongly based on occurrence TrIAS indicators.\n\n\nFirst, list and load the needed packages.\n\n\nCode\nlibrary(readr)\nlibrary(dplyr)\nlibrary(tidyr)\nlibrary(purrr)\nlibrary(tibble)"
  },
  {
    "objectID": "src/from_cube_to_emerging_status.html#scope",
    "href": "src/from_cube_to_emerging_status.html#scope",
    "title": "Emerging status determination based on GBIF species occurrence cubes",
    "section": "2 Scope",
    "text": "2 Scope\n\n2.1 Taxonomic scope\nSpecies of interest:\n\nImpatiens capensis (GBIF key: 2891774)\nXenopus laevis (GBIF key: 5217334)\nMyriophyllum heterophyllum (GBIF key: 5361762)\nContarinia pseudotsugae (GBIF key: 5082110)\nProcyon lotor (GBIF key: 5218786)\nHalyomorpha halys (GBIF key: 4485843)\nVespa velutina (GBIF key: 1311477)\nCydalima perspectalis (GBIF key: 4532122)\nExaireta spinigera (GBIF key: 1579447)\nHermetia illucens (GBIF key: 1577153)\n\n\n\nCode\nspecies &lt;- tibble::tibble(\n  specieskey = c(2891774,\n                 5217334,\n                 5361762,\n                 5082110, \n                 5218786,\n                 4485843,\n                 1311477,\n                 4532122,\n                 1579447,\n                 1577153),\n  canonical_name = c(\"Impatiens capensis\",\n                     \"Xenopus laevis\",\n                     \"Myriophyllum heterophyllum\",\n                     \"Contarinia pseudotsugae\",\n                     \"Procyon lotor\",\n                     \"Halyomorpha halys\",\n                     \"Vespa velutina\",\n                     \"Cydalima perspectalis\",\n                     \"Exaireta spinigera\",\n                     \"Hermetia illucens\")\n)\n\n\n\n\n2.2 Spatial scope\nWe are interested over the emerging status of the four species in Europe.\n\n\n2.3 Temporal scope\nWe request a species occurrence cube based on data from 1950."
  },
  {
    "objectID": "src/from_cube_to_emerging_status.html#species-occurrence-cube",
    "href": "src/from_cube_to_emerging_status.html#species-occurrence-cube",
    "title": "Emerging status determination based on GBIF species occurrence cubes",
    "section": "3 Species occurrence cube",
    "text": "3 Species occurrence cube\nWe triggered a GBIF occurrence cube via the Occurrence SQL Download API and on the hand of a JSON query (query_for_GAM_graphs.json). The resulting cube (DOI: 10.15468/dl.jzja7g, downloadKey: 0069617-241126133413365) can be downloaded in TSV format from GBIF. We have it saved at data/input as 0069617-241126133413365.csv:\n\n\nCode\ncube &lt;- readr::read_tsv(\n  here::here(\n    \"data\",\n    \"input\",\n    \"0069617-241126133413365.csv\"\n  )\n)\n\n\nPreview:\n\n\nCode\nhead(cube)"
  },
  {
    "objectID": "src/from_cube_to_emerging_status.html#from-cubes-to-emerging-status",
    "href": "src/from_cube_to_emerging_status.html#from-cubes-to-emerging-status",
    "title": "Emerging status determination based on GBIF species occurrence cubes",
    "section": "4 From cubes to emerging status",
    "text": "4 From cubes to emerging status\n\n4.1 Preprocess: from cube to time series\nWe assess the emerging status of the four species in Europe for 2023. First, we create time series up to 2023 as the data of 2024 could be not yet entirely published.\n\n\nCode\nlast_year &lt;- 2023\n\n\nFor each species, define cells with at least one observation:\n\n\nCode\ndf_cc &lt;-   cube |&gt;\n  dplyr::group_by(specieskey) |&gt;\n  dplyr::distinct(eeacellcode) |&gt;\n  dplyr::ungroup()\n\n\nFor each species, identify the first year with at least one observation:\n\n\nCode\ndf_begin_year &lt;-\n  cube |&gt;\n  dplyr::group_by(specieskey) |&gt;\n  dplyr::summarize(begin_year = min(year))\n\n\nFor each species, combine begin_year and unique eeacellcode as found above:\n\n\nCode\ndf_cc &lt;-   df_cc |&gt;\n  dplyr::left_join(df_begin_year, by = \"specieskey\") |&gt; \n  dplyr::select(specieskey, begin_year, eeacellcode)\n\n\nPreview:\n\n\nCode\nhead(df_cc)\n\n\n\n  \n\n\n\nFor each cell (eeacellcode) and species (specieskey) we can now create a time series:\n\n\nCode\n# Define help function\nmake_time_series &lt;- function(eeacellcode, specieskey, begin_year, last_year) {\n  tidyr::expand_grid(\n    eeacellcode = eeacellcode,\n    specieskey = specieskey,\n    year = seq(from = begin_year, to = last_year)\n  )\n}\n\n# Create timeseries slots\ndf_ts &lt;- purrr::pmap_dfr(df_cc,\n  .f = make_time_series,\n  last_year = last_year\n)\n\n# Add occurrence data\ndf_ts &lt;-\n  df_ts |&gt;\n  dplyr::left_join(\n    cube |&gt; dplyr::select(\n      specieskey,\n      year,\n      eeacellcode,\n      occurrences\n    ),\n    by = c(\"specieskey\", \"year\", \"eeacellcode\")\n  )\n\n# Replace NAs with 0\ndf_ts &lt;-\n  df_ts |&gt;\n  tidyr::replace_na(list(occurrences = 0))\n\n\nAdd column for presence (1) or absence (0):\n\n\nCode\ndf_ts &lt;-\n  df_ts |&gt;\n  dplyr::mutate(\n    ispresent = dplyr::if_else(occurrences &gt; 0, 1, 0)\n  )\n\n\nSave the time series as an interim output:\n\n\nCode\nreadr::write_tsv(\n  df_ts,\n  here::here(\"data\", \"interim\", \"time_series.tsv\"),\n  na = \"\"\n)\n\n\n\n\n4.2 Apply GAM\nWe are now ready to apply GAM to assess the emerging status of the four species in 2023.\n\n\nCode\neval_year &lt;- 2023\n\n\nLet’s compact the time series:\n\n\nCode\ncompact_df_ts &lt;- df_ts |&gt;\n    dplyr::group_by(specieskey, year) |&gt;\n    dplyr::summarise(\n      occs = sum(occurrences),\n      ncells = sum(ispresent),\n      .groups = \"drop\")\n\n\nPlots will be saved in ./data/output/GAM_outputs directory:\n\n\nCode\ndir_name_basic &lt;- here::here(\"data\", \"output\", \"GAM_outputs\")\n\n\nWe also define the plot dimensions in pixels:\n\n\nCode\nplot_dimensions &lt;- list(width = 2800, height = 1500)\n\n\nWe apply GAM for each taxon for the number of occurrences:\n\n\nCode\ngam_occs &lt;- purrr::map2(\n    species$specieskey, species$canonical_name,\n    function(t, n) {\n      df_key &lt;- compact_df_ts |&gt;\n        dplyr::filter(specieskey == t)\n      trias::apply_gam(\n        df = df_key,\n        y_var = \"occs\",\n        taxonKey = \"specieskey\",\n        eval_years = 2023,\n        type_indicator = \"observations\",\n        taxon_key = t,\n        name = n,\n        dir_name = dir_name_basic,\n        y_label = \"observations\",\n        saveplot = TRUE,\n        width = plot_dimensions$width,\n        height = plot_dimensions$height\n      )\n    })\nnames(gam_occs) &lt;- species$canonical_name\n\n\nAnd the number of occupied cells, or measured occupancy:\n\n\nCode\ngam_ncells &lt;- purrr::map2(\n    species$specieskey, species$canonical_name,\n    function(t, n) {\n      df_key &lt;- compact_df_ts |&gt;\n        dplyr::filter(specieskey == t)\n      trias::apply_gam(\n        df = df_key,\n        y_var = \"ncells\",\n        taxonKey = \"specieskey\",\n        eval_years = 2023,\n        type_indicator = \"occupancy\",\n        taxon_key = t,\n        name = n,\n        dir_name = dir_name_basic,\n        y_label = \"number of occupied cells\",\n        saveplot = TRUE,\n        width = plot_dimensions$width,\n        height = plot_dimensions$height\n      )\n    })\nnames(gam_ncells) &lt;- species$canonical_name\n\n\n\n\n4.3 Plots\nPlease go to ./data/output/GAM_outputs to get a look to the plots.\nFor the paper, we need to arrange them in a grid. Of course now we have too many plots. So, let’s show just four GAM plots in a 2x2 grid. First, for the number of occurrences:\n\n\nCode\ngrid_occs &lt;- purrr::map(\n  list(gam_occs$`Impatiens capensis`,\n       gam_occs$`Myriophyllum heterophyllum`,\n       gam_occs$`Procyon lotor`,\n       gam_occs$`Vespa velutina`),\n  function(x) {\n    x$plot\n  }\n) |&gt;\n  # Unify legends\n  patchwork::wrap_plots(ncol = 2) |&gt;\n  patchwork::plot_layout(guides = \"collect\")\ngrid_occs\n\n\n$ncol\n\n\n\n\n\n\n\n\n\n\n$nrow\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\n$byrow\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\n$widths\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\n$heights\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\n$guides\n[1] \"collect\"\n\n$tag_level\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\n$axes\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\n$axis_titles\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\n$design\nlist()\nattr(,\"class\")\n[1] \"waiver\"\n\nattr(,\"class\")\n[1] \"plot_layout\"\n\n\nSecond, for the number of occupied cells (measured occupancy):\n\n\nCode\ngrid_ncells &lt;- purrr::map(\n  list(gam_ncells$`Impatiens capensis`,\n       gam_ncells$`Myriophyllum heterophyllum`,\n       gam_ncells$`Procyon lotor`,\n       gam_ncells$`Vespa velutina`),\n  function(x) {\n    x$plot\n  }\n) |&gt;\n  patchwork::wrap_plots(ncol = 2)\ngrid_ncells"
  }
]